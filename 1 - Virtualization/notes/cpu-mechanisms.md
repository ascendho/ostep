# cpu-mechanisms

## 核心结论
有限直接执行（LDE）是CPU虚拟化的核心底层机制，核心逻辑是“让程序直接在CPU上运行以保证效率，通过硬件限制+中断/陷阱机制保证OS控制权”，最终平衡CPU虚拟化的**高效性**与OS的**控制能力**。

## 一、LDE核心原理
### 1. 定义与核心思想
- 直接执行（Direct Execution）：OS加载程序后，让其直接在CPU上运行原生指令，避免额外开销，保证执行效率。
- 有限（Limited）：通过硬件和OS协作，限制程序的特权操作（如I/O、修改CPU状态），确保OS始终掌握系统控制权，避免程序失控。
- 核心目标：解决“高效运行程序”与“OS保持控制”的矛盾，是现代OS实现CPU虚拟化的基础。

### 2. 核心挑战
LDE面临两个关键问题，需通过硬件+OS协同解决：
1. 如何处理程序的**受限操作**（如I/O、系统资源申请），避免程序滥用权限；
2. 如何**切换进程**（OS未运行时，如何夺回CPU控制权以实现分时复用）。

## 二、关键问题1：受限操作的解决机制
为防止程序执行危险操作，OS与硬件通过“特权分级+系统调用+陷阱机制”实现管控：

### 1. 特权模式分级
- 硬件提供两种CPU执行模式：
  -  用户态（User Mode）：程序运行时的默认模式，禁止执行特权操作（如I/O、修改陷阱表），违规会触发异常。
  - 内核态（Kernel Mode）：OS运行模式，可执行所有硬件操作，拥有完整系统权限。

### 2. 系统调用（System Call）流程
程序需执行特权操作时，通过系统调用向OS求助，流程如下：
1. 程序调用C库封装的接口（如`open()`），库函数将系统调用号、参数放入指定寄存器/栈；
2. 执行**陷阱指令（Trap）**：触发硬件切换到内核态，并跳转到OS预设的陷阱处理程序；
3. OS验证系统调用合法性，执行对应特权操作（如I/O）；
4. 执行**返回-from-trap指令**：切换回用户态，恢复程序寄存器状态，继续执行程序。

### 3. 陷阱表（Trap Table）
- OS在开机时初始化陷阱表，记录各类异常（系统调用、中断、非法操作）对应的处理程序地址，并通过特权指令告知硬件；
- 硬件固定陷阱表地址，禁止用户程序修改，确保所有陷阱都路由到OS可信代码，避免恶意跳转。

## 三、关键问题2：进程切换的解决机制
OS需夺回CPU控制权才能切换进程，分为两种实现方式：

### 1. 协作式调度（Cooperative Scheduling）
- 原理：依赖程序主动放弃CPU（如调用系统调用、触发异常），OS在程序陷入内核时切换进程；
- 优点：实现简单，无额外开销；
- 缺点：不可靠，若程序陷入死循环不放弃CPU，OS无法干预，只能重启。

### 2. 非协作式调度（Non-Cooperative Scheduling）
- 核心硬件支持：**定时器中断（Timer Interrupt）**，解决程序不协作的问题：
  1. OS开机时启动定时器（特权操作），设置每隔固定时间（如毫秒级）触发一次中断；
  2. 定时器触发时，硬件暂停当前程序，保存其寄存器状态，切换到内核态，执行OS的中断处理程序；
  3. OS此时夺回控制权，可决定是否切换进程。

### 3. 上下文切换（Context Switch）
当OS决定切换进程时，通过以下步骤实现：
1. 保存当前进程上下文：将其寄存器（PC、栈指针、通用寄存器）保存到进程控制块（PCB）的内核栈；
2. 恢复目标进程上下文：从目标进程的PCB中加载寄存器状态，切换到其内核栈；
3. 执行返回-from-trap指令：切换到用户态，启动目标进程执行。
- 关键：上下文切换的开销来自寄存器保存/恢复，现代系统已优化到亚微秒级。

## 四、硬件核心支持清单
LDE的实现依赖硬件提供以下关键功能：
1. 双特权模式（用户态/内核态）：限制程序权限；
2. 陷阱指令与返回-from-trap指令：实现用户态到内核态的安全切换；
3. 陷阱表配置接口：允许OS设置异常处理程序地址（特权操作）；
4. 定时器中断：强制夺回CPU控制权；
5. 寄存器自动保存/恢复：陷阱/中断发生时，硬件自动保存程序关键寄存器（如PC、 flags）到内核栈。

## 五、核心总结
1. LDE的本质：“直接执行”保证效率，“硬件限制+陷阱/中断”保证控制，是CPU虚拟化的基石；
2. 两大核心机制：通过“用户态/内核态+系统调用”解决受限操作，通过“定时器中断+上下文切换”解决进程切换；
3. 硬件是关键：所有控制逻辑都依赖硬件提供的特权分级、陷阱、中断等功能，OS无法独立实现；
4. 平衡目标：LDE让程序高效运行（原生指令执行），同时OS通过中断/陷阱机制随时介入，确保系统可控。

## 六、作业方向（Measurement）
核心任务：测量系统调用和上下文切换的性能开销，关键步骤：
1. 测量系统调用成本：反复执行空系统调用（如0字节`read()`），通过`gettimeofday()`或`rdtsc`指令统计平均耗时；
2. 测量上下文切换成本：通过UNIX管道让两个进程通信，触发频繁上下文切换，统计通信循环耗时，推导切换成本；
3. 注意事项：绑定进程到同一CPU（如Linux`Sched_setaffinity()`），避免多CPU调度干扰测量结果。
