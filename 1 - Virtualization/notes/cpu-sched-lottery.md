# cpu-sched-lottery

## 核心结论
比例共享调度是一类以“按比例分配CPU时间”为目标的调度算法，核心是让进程获得的CPU时间与其“份额占比”匹配，而非优化周转时间或响应时间。主流实现包括**彩票调度（概率型）**、**步长调度（确定型）** 和Linux的**完全公平调度器（CFS，实用型）**，分别平衡了实现简单性、比例精确性和实际系统的高效性。

## 一、基础概念：份额的表示与核心目标
### 1. 核心目标
- 不为单一进程优化（如短作业优先），而是保证：进程获得的CPU时间占比 ≈ 其“份额占比”（如持有75%的份额则获得75%的CPU时间）。
- 适用场景：云服务器、虚拟机分配等需要明确资源占比的场景。

### 2. 份额的核心载体：Ticket（票）
- Ticket 是比例的具象化表示，进程持有的 Ticket 数量决定其份额占比（总 Ticket 数为所有进程 Ticket 之和）。
- 示例：进程A持75票，进程B持25票，则A应获得75%的CPU时间。

## 二、彩票调度（Lottery Scheduling）：概率型比例共享
### 1. 核心原理
- 每次调度时“抽奖”：生成0~总票数十间的随机数（中奖票），持有该票的进程获得CPU时间片。
- 比例保证：长期运行下，进程运行次数≈其 Ticket 占比（概率性正确，短期可能有偏差）。

### 2. 关键机制（灵活调整份额）
- **Ticket 货币**：用户可自定义内部货币分配 Ticket，系统自动转换为全局 Ticket（如用户A有100全局票，给内部两个进程各500“用户币”，自动转为各50全局票）。
- **Ticket 转移**：进程可临时将 Ticket 转移给其他进程（如客户端给服务器转移 Ticket 以加速处理请求）。
- **Ticket 膨胀**：信任环境中，进程可临时增减自身 Ticket，反映短期CPU需求（非信任环境易被滥用）。

### 3. 实现逻辑（极简）
1. 维护所有进程的 Ticket 数和总 Ticket 数；
2. 生成随机中奖票；
3. 遍历进程列表累加 Ticket 数，首次超过中奖票的进程即为赢家（示例代码见图9.1）。

### 4. 优缺点
- 优点：实现简单、无全局状态（新增进程直接加 Ticket 即可，无需调整其他进程）、轻量化。
- 缺点：短期比例不精确（如20次调度中，25%份额的进程可能仅运行4次）；进程运行时间越短，公平性越差。

## 三、步长调度（Stride Scheduling）：确定型比例共享
### 1. 核心原理
- 用“确定性逻辑”替代随机抽奖，确保比例精确：
  1. 步长（Stride）：与 Ticket 成反比，公式为「Stride = 大常数 / Ticket 数」（Ticket 越多，Stride 越小）；
  2. 通行证（Pass）：进程初始 Pass=0，每次运行后 Pass += Stride；
  3. 调度规则：每次选择 Pass 最小的进程运行。

### 2. 示例与比例保证
- 示例：进程A（100票）、B（50票）、C（250票），大常数=10000，则 Stride 分别为100、200、40；
- 运行轨迹：Pass 累加后，C（Stride=40）运行次数最多，A次之，B最少，完全匹配 Ticket 比例（250:100:50）。

### 3. 优缺点
- 优点：比例精确（短期也符合预期）、无随机波动。
- 缺点：存在全局状态（Pass），新增进程时 Pass 初始值难设定（设为0可能导致垄断CPU）；实现复杂度高于彩票调度。

## 四、Linux 完全公平调度器（CFS）：实用型比例共享
CFS 是 Linux 主流调度器，以“动态时间片+虚拟运行时”实现高效、公平的比例共享，兼顾理论比例与实际系统性能。

### 1. 核心设计：虚拟运行时（vruntime）
- 定义：进程的“虚拟运行时间”，用于衡量其已占用的CPU资源。
- 调度规则：每次选择 vruntime 最小的进程运行，确保“谁占用CPU少，谁先运行”。

### 2. 动态时间片计算（平衡公平与性能）
- 关键参数：
  - `sched_latency`（调度延迟）：默认48ms，代表“一轮调度中覆盖所有进程”的目标时间；
  - `min_granularity`（最小粒度）：默认6ms，避免时间片过小导致上下文切换开销过大。
- 时间片公式：`time_slice = sched_latency / 进程数`（若结果<min_granularity，则取min_granularity）。
- 示例：4个进程时，时间片=48ms/4=12ms；10个进程时，理论值=4.8ms，实际取6ms。

### 3. 优先级支持：Nice 级别与权重映射
- Nice 级别：范围-20（最高优先级）~+19（最低优先级），默认0；
- 权重映射：Nice 级别对应固定权重（如 Nice=0 权重=1024，Nice=-5 权重=3121）；
- 比例调整：
  1. 时间片比例 = 进程权重 / 所有进程权重之和；
  2. vruntime 累加公式：`vruntime += (1024 / 进程权重) * 实际运行时间`（高权重进程 vruntime 增长慢，能获得更多CPU时间）。

### 4. 高效数据结构：红黑树
- 用途：存储所有可运行进程，按 vruntime 排序；
- 优势：插入、删除、查询最小 vruntime 进程的时间复杂度均为 O(log n)，适配千级进程场景（列表为 O(n)，效率过低）。

### 5. 特殊场景处理：睡眠进程唤醒
- 问题：长期睡眠进程的 vruntime 远低于运行进程，唤醒后可能垄断CPU；
- 解决方案：唤醒时将其 vruntime 设为红黑树中最小 vruntime，避免饥饿。

## 五、三种调度算法对比
| 特性                | 彩票调度                | 步长调度                | CFS（Linux）            |
|---------------------|-------------------------|-------------------------|-------------------------|
| 比例保证            | 概率性（长期正确）      | 确定性（短期也正确）    | 近似比例（实用平衡）    |
| 实现复杂度          | 极低                    | 中等                    | 较高（工业级实现）      |
| 新增进程兼容性      | 极佳（无全局状态）      | 较差（需处理 Pass 初始值）| 极佳（红黑树动态插入）  |
| 适用场景            | 简单比例分配、轻量系统  | 需精确比例的场景        | 通用操作系统（Linux）  |
| 优先级支持          | 无（需扩展 Ticket 数）  | 无（需扩展 Stride）     | 原生支持（Nice+权重）  |

## 六、核心总结
1. 比例共享调度的核心是“按份额分配CPU”，Ticket 是份额的统一载体；
2. 彩票调度胜在简单灵活，步长调度胜在比例精确，CFS胜在实用高效（工业级落地）；
3. 实际系统中，CFS 是主流选择，通过动态时间片、红黑树、vruntime 等设计，平衡了公平性、效率和扩展性；
4. 局限性：对I/O密集型进程友好性不足（睡眠后可能无法获得公平份额）；份额分配（如 Ticket/权重设定）仍是未解决的核心问题。

## 七、作业方向（Simulation）
通过 `lottery.py` 模拟器验证彩票调度特性，核心任务：
1. 不同随机种子下，3个进程的调度结果与比例匹配度；
2. 极端 Ticket 分配（1:100）对调度的影响（低 Ticket 进程是否能运行）；
3. 进程长度、时间片大小（-q 参数）对公平性的影响；
4. 绘制公平性随进程长度变化的图表，对比彩票调度与步长调度的差异。
