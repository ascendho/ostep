# vm-beyondphys

## 核心结论
OS通过**交换空间（Swap Space）+ 页故障（Page Fault）+ 页面置换（Page Replacement）** 三大核心机制，可让进程使用远超物理内存的虚拟地址空间。核心逻辑是：将暂时不用的页面换出到磁盘交换空间，需要时再换入物理内存，全程对进程透明，既保证了多进程并发的内存利用率，又简化了程序员对内存的使用（无需手动管理内存覆盖）。

## 一、核心问题（CRUX）
如何利用“更大但较慢的磁盘设备”，透明地为进程提供远超物理内存的虚拟地址空间？需通过哪些底层机制实现页面在内存与磁盘间的灵活切换，同时保证系统性能？

## 二、核心机制详解
### 1. 交换空间（Swap Space）：磁盘上的“虚拟内存扩展区”
#### （1）定义与作用
- 交换空间是磁盘上预留的连续区域，专门用于存放从物理内存换出的页面，是虚拟内存的“扩展存储”。
- 核心作用：突破物理内存容量限制，支持多进程并发（多个进程的页面可部分存于交换空间，仅核心页面在内存）。

#### （2）关键特性
- 大小决定系统最大可用页面数：交换空间越大，能同时支持的进程/页面越多；
- 页面交换单位：以“页”为最小单位（与物理内存页大小一致），OS需记录页面在交换空间的磁盘地址；
- 额外来源：代码页（如程序二进制文件）可直接从文件系统换入，无需占用交换空间（因代码只读，可重复加载）。

#### （3）示例场景
4页物理内存 + 8页交换空间，3个进程可同时运行：部分页面在物理内存，其余页面（如进程0的VPN1、进程3的所有页面）存于交换空间，进程3未运行时所有页面可完全换出。

### 2. 存在位（Present Bit）：页面位置的“标记器”
#### （1）引入目的
区分页面的两种状态：“在物理内存中”或“在磁盘交换空间中”，是触发页故障的关键标识。

#### （2）位含义与PTE扩展
- 页表项（PTE）新增“存在位”：
  - 存在位=1：页面在物理内存，PTE中存储物理页框号（PFN）；
  - 存在位=0：页面在磁盘，PTE中存储页面在交换空间的磁盘地址。
- 与有效位的区别：有效位标记页面是否属于进程地址空间（无效则触发段错误）；存在位标记有效页面的存储位置（不在内存则触发页故障）。

### 3. 页故障（Page Fault）：页面换入的“触发信号”
当进程访问的页面“有效但不存在于物理内存”（存在位=0）时，硬件触发**页故障**，OS通过页故障处理程序完成页面换入。

#### （1）页故障与非法访问的区别
- 页故障：页面属于进程地址空间（有效位=1），仅暂时不在内存，是“合法但需等待I/O”的故障；
- 非法访问：页面不属于进程地址空间（有效位=0），触发段错误（Segmentation Fault），OS通常终止进程。

#### （2）页故障处理流程（OS核心工作）
1. 查找空闲物理页框：若内存有空闲页框，直接使用；若无，则触发**页面置换**（Evict Page），换出内存中低优先级页面到交换空间；
2. 磁盘I/O请求：根据PTE记录的磁盘地址，向磁盘发送读请求，将目标页面加载到空闲页框；
3. 进程阻塞：页面加载期间（磁盘I/O耗时），进程进入阻塞态，OS切换到其他就绪进程，提高CPU利用率；
4. 更新PTE与重试：I/O完成后，OS更新PTE（存在位=1、填入PFN），重试触发页故障的指令；
5. TLB更新：重试时可能触发TLB未命中，OS/硬件将新的VPN→PFN映射写入TLB，后续访问直接命中。

### 4. 页面置换触发：内存满时的“空间回收”
#### （1）核心场景
当内存无空闲页框，且需换入新页面时，OS必须选择一个内存中的页面换出到交换空间，这个“选页换出”的过程称为页面置换，由**页面置换策略**决定（下一章详细讲解）。

#### （2）关键原则
- 置换目标：优先换出“低价值页面”（如长期未访问、只读页面），避免频繁换入换出（抖动）；
- 脏页处理：若页面被修改（脏位=1），需先写入交换空间再释放页框；若为只读页（如代码页），可直接释放（后续需时从文件系统重新加载）。

### 5. 完整控制流：从内存访问到页故障处理
#### （1）硬件控制流（地址翻译阶段）
```
1. 拆分VPN与Offset，查询TLB→命中则直接生成物理地址；
2. TLB未命中→查询页表（PTE）；
3. PTE有效位=0→触发段错误（终止进程）；
4. PTE有效位=1→检查存在位：
   a. 存在位=1→更新TLB，重试指令；
   b. 存在位=0→触发页故障（交给OS处理）。
```

#### （2）OS控制流（页故障处理阶段）
```
1. 查找空闲物理页框→无则执行页面置换；
2. 向磁盘发送读请求，加载目标页面到页框；
3. 等待I/O完成（进程阻塞，OS调度其他进程）；
4. 更新PTE（存在位=1、填入PFN）；
5. 重试原指令→TLB命中，完成内存访问。
```

### 6. 后台页面守护进程：主动回收内存
#### （1）核心目的
避免内存完全满时才触发置换（导致进程阻塞等待），提前回收内存，保持系统响应性。

#### （2）水位线机制（High Watermark/HW + Low Watermark/LW）
- 低水位线（LW）：内存空闲页框低于此值时，后台守护进程（swap daemon/page daemon）启动；
- 高水位线（HW）：守护进程持续置换页面，直到空闲页框达到此值后休眠；
- 优化点：批量置换页面并写入磁盘，减少磁盘寻道/旋转延迟，提升I/O效率。

## 三、核心优势与关键注意事项
### 1. 核心优势
- 透明性：进程无需感知页面在内存与磁盘间的切换，认为自己拥有连续的虚拟地址空间；
- 利用率：物理内存仅存放活跃页面，支持更多进程并发，提高CPU和内存利用率；
- 易用性：程序员无需手动管理内存覆盖（如早期系统的overlay），直接按需分配内存。

### 2. 关键注意事项
- 页故障代价高：磁盘I/O耗时是内存访问的10⁴~10⁵倍，频繁页故障会导致系统性能骤降（抖动）；
- 交换空间有限：超出交换空间容量时，内存分配失败（进程无法扩展虚拟内存）；
- 脏页开销：修改过的页面换出时需额外写入磁盘，比只读页置换开销更大。

## 四、核心总结
1. 超越物理内存的本质：用“磁盘交换空间”扩展虚拟内存，通过“页故障触发换入、页面置换触发换出”实现页面动态流转；
2. 核心组件协同：存在位标记页面位置→页故障触发换入→页面置换回收空间→后台守护进程提前优化，构成完整机制；
3. 性能关键：页面置换策略决定系统性能（避免频繁换入换出），批量I/O和水位线机制降低磁盘开销；
4. 适用场景：所有现代OS（Linux、Windows、macOS），是支持大地址空间和多进程并发的基础。

## 五、作业方向（Measurement）
通过`vmstat`工具观察内存、CPU、I/O统计，验证虚拟内存机制，核心任务：
1. 运行`mem.c`程序（不同内存占用量），观察CPU使用率变化，分析多实例运行时的资源竞争；
2. 监控`swpd`（交换空间使用量）和`free`（空闲内存），观察程序启动/退出时的内存变化；
3. 测试超物理内存的场景，观察`si`（换入）和`so`（换出）统计，分析循环执行时的交换量；
4. 对比“内存内运行”与“频繁交换”的性能差异，绘制内存占用量与访问带宽的关系图；
5. 测试交换空间上限，观察内存分配失败的临界值；
6. 对比不同存储设备（硬盘、SSD、RAID）的交换性能，分析设备速度对虚拟内存的影响。
